<!DOCTYPE html>
<html lang="en" class="font-size-1">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>{{ doc_title }} - {{site_name}}</title>
<meta property="og:title" content="{{ doc_title }}">
<meta property="og:description" content="{{ og_description }}">
<meta property="og:type" content="website">
{% if og_image %}
  {% if absolute_url %}
    <meta property="og:image" content="{{ absolute_url }}/{{ og_image }}">
  {% else %}
    <meta property="og:image" content="{{ og_image }}">
  {% endif %}
{% endif %}
<meta property="og:site_name" content="{{site_name}}">

{# Advertise Atom feed #}
{% if absolute_url %}
  <link rel="alternate" type="application/atom+xml"
        title="{{ story_title }} — Adventure Log (Atom)"
        href="{{ absolute_url }}/{{ atom_href }}">
{% else %}
  <link rel="alternate" type="application/atom+xml"
        title="{{ story_title }} — Adventure Log (Atom)"
        href="{{ atom_href }}">
{% endif %}

<style>{{ css | safe }}</style>
<link href="/css/index.css" rel="stylesheet">
</head>
<body>
<div id="page-wrapper">
  <div id="page-outer">
    <div id="page">
      {% if visible_title %}
      <h2 id="title">{{ visible_title }}</h2>
      {% endif %}
      <div id="media">
        {% for u in images %}
        <img src="{{ u }}" alt="{{ alts[loop.index0] }}">
        {% endfor %}
      </div>
      <div id="content" data-s="jq" data-p="{{ "%06d"|format(page_number) }}">
        {% for p in paragraphs %}
        <p class="comic-text">{{ p }}</p>
        {% endfor %}
        <div class="commands">
        {% if command_text %}
          &gt; <a href="{{ command_href }}">{{ command_text }}</a>
        {% else %}
          <span class="placeholder" aria-hidden="true">&gt;</span>
        {% endif %}
        </div>

        <div id="page-footer">
          <ul id="page-footer-left">
            <li><a id="start-over" href="{{ start_over_href }}">Start Over</a></li>
            <li><a id="go-back" href="{{ go_back_href }}">Go Back</a></li>
            <li><a id="open-log" href="javascript:void(0)">Log</a></li>
          </ul>
          <ul id="page-footer-right">
            <li>
              <span>Fan Mirror by {{site_name}} <a href="https://github.com/recordcrash/quest-mirrorer">↗️</a></span>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Log modal -->
<div id="log-modal" class="log-modal" hidden>
  <div class="log-card" role="dialog" aria-modal="true" aria-labelledby="log-title">
    <div class="log-header">
      <strong id="log-title">Adventure Log</strong>
      {# Atom feed link next to the log title #}
      <a class="feed-link"
         href="{{ absolute_url ~ '/' ~ atom_href if absolute_url else atom_href }}"
         rel="alternate"
         type="application/atom+xml"
         title="Subscribe to the Atom feed"
         aria-label="Subscribe to the Atom feed">{{ feed_icon }}</a>
      <button id="log-close" aria-label="Close">Close</button>
    </div>
    <div class="log-list">
      {% for item in log_items %}
      <div class="log-row">
        <span class="log-date">{{ item.date }}</span>
        <span class="log-sep">-</span>
        <a class="log-link" href="{{ item.href }}">
          {% if item.title %}{{ item.title }}{% else %}Page {{ item.num }}{% endif %}
        </a>
      </div>
      {% endfor %}
    </div>
  </div>
</div>

<script>
(function(){
  var page = {{ page_number }};
  var total = {{ total_pages }};
  function go(n){
    if (n < 1) n = 1;
    if (n > total) return;
    var href = (n === 1) ? "1.html" : String(n) + ".html";
    window.location.href = href;
  }
  document.addEventListener("keydown", function(e){
    if (e.target && (e.target.tagName === "INPUT" || e.target.tagName === "TEXTAREA" || e.target.isContentEditable)) return;
    if (e.key === "ArrowLeft"){ if (page > 1) go(page - 1); }
    else if (e.key === "ArrowRight"){ if (page < total) go(page + 1); }
    else if (e.key === "Escape"){ var m = document.getElementById("log-modal"); if (m && !m.hidden) m.hidden = true; }
  });

  var modal = document.getElementById("log-modal");
  var openBtn = document.getElementById("open-log");
  var closeBtn = document.getElementById("log-close");
  if (openBtn && modal){ openBtn.addEventListener("click", function(){ modal.hidden = false; }); }
  if (closeBtn && modal){ closeBtn.addEventListener("click", function(){ modal.hidden = true; }); }
  if (modal){ modal.addEventListener("click", function(e){ if (e.target === modal) modal.hidden = true; }); }
})();
</script>
</body>
</html>
